# OneTimeMail システム設計書

## 1. システム概要

### 1.1 プロジェクト名
OneTimeMail（ワンタイムメール）

### 1.2 目的
IoTデバイス設定代行サービス向けの一時メールアドレス発行・受信サービス

### 1.3 アーキテクチャ概要
- **フロントエンド**: Next.js + TypeScript
- **バックエンド**: AWS Amplify Gen2
- **データベース**: DynamoDB（Amplify data）
- **メール**: S3（SESで受信したメールを保存）
- **認証**: 不要（匿名利用）

## 2. システム構成

### 2.1 全体構成図
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Next.js App   │    │  Amplify Gen2   │    │      S3         │
│   (Frontend)    │◄──►│   (Backend)     │◄──►│  (Mail Storage) │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   DynamoDB      │
                       │  (Amplify data) │
                       └─────────────────┘
```

### 2.2 コンポーネント構成

#### 2.2.1 フロントエンド（Next.js）
```
src/
├── app/
│   ├── page.tsx              # メイン画面
│   ├── layout.tsx            # レイアウト
│   └── globals.css           # スタイル
├── components/
│   ├── EmailGenerator.tsx    # メールアドレス生成
│   ├── EmailList.tsx         # メール一覧
│   ├── EmailViewer.tsx       # メール詳細
│   └── CopyButton.tsx        # コピーボタン
├── hooks/
│   ├── useEmailAddress.ts    # メールアドレス管理
│   ├── useEmailList.ts       # メール一覧管理
│   └── useS3Checker.ts       # S3メールチェック
├── utils/
│   ├── api.ts                # API呼び出し
│   ├── s3.ts                 # S3操作
│   └── emailGenerator.ts     # メールアドレス生成
└── types/
    └── index.ts              # 型定義
```

#### 2.2.2 バックエンド（Amplify Gen2 + Next.js Server Actions）
```
amplify/
├── backend.ts                # バックエンド定義
├── data/
│   └── resource.ts           # データスキーマ
└── storage/
    └── resource.ts           # S3設定

app/
├── actions/
│   └── email-actions.ts      # Server Actions（メール処理）
└── utils/
    └── amplify-utils.ts      # Amplify設定・ユーティリティ
```

## 3. データ設計

### 3.1 データベーススキーマ（Amplify data）

#### 3.1.1 EmailAddress（メールアドレス管理）
```typescript
EmailAddress: {
  id: string                    // プライマリキー
  address: string               // メールアドレス（ユニーク）
  createdAt: timestamp          // 作成日時
  isActive: boolean             // アクティブ状態
}
```

#### 3.1.2 インデックス設計
```typescript
// EmailAddress
- Primary Key: id
- GSI1: address (ユニーク)
```

### 3.2 メールアドレス生成ルール
- **形式**: `{西暦右2桁}{月}{日}{連番3桁}@otm.mec.mejsh.com`
- **例**: `250908001@otm.mec.mejsh.com`
- **重複チェック**: DynamoDBでユニーク制約

## 4. 機能設計

### 4.1 メールアドレス生成機能

#### 4.1.1 生成ロジック
```typescript
function generateEmailAddress(): string {
  const now = new Date();
  const year = now.getFullYear().toString().slice(-2); // 西暦右2桁
  const month = (now.getMonth() + 1).toString().padStart(2, '0'); // 月
  const day = now.getDate().toString().padStart(2, '0'); // 日
  
  // 連番3桁（000-999）
  const sequence = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  
  return `${year}${month}${day}${sequence}@otm.mec.mejsh.com`;
}
```

#### 4.1.2 重複チェック
```typescript
async function checkEmailAddressExists(address: string): Promise<boolean> {
  // Amplify dataで既存のメールアドレスを検索
  const result = await client.queries.getEmailAddress({ address });
  return result.data !== null;
}
```

### 4.2 メール受信・表示機能

#### 4.2.1 S3メールチェック
```typescript
import { list, getUrl } from 'aws-amplify/storage';

async function checkS3Emails(emailAddress: string): Promise<Email[]> {
  // S3バケット: otm-mec-mejsh-com-recieve
  // プレフィックス: email/
  const listResult = await list({
    prefix: 'email/',
    options: {
      bucketName: 'otm-mec-mejsh-com-recieve'
    }
  });
  
  const emails: Email[] = [];
  
  if (listResult.items) {
    for (const item of listResult.items) {
      if (item.key) {
        try {
          // メールファイルのURLを取得
          const url = await getUrl({
            key: item.key,
            options: {
              bucketName: 'otm-mec-mejsh-com-recieve'
            }
          });
          
          // メールファイルを取得
          const response = await fetch(url.url);
          const emailContent = await response.text();
          
          // メールアドレス宛かチェック
          if (isEmailForAddress(emailContent, emailAddress)) {
            emails.push(parseEmailContent(emailContent, item.key));
          }
        } catch (error) {
          console.error(`Error processing email file ${item.key}:`, error);
        }
      }
    }
  }
  
  return emails;
}
```

#### 4.2.2 メール解析
```typescript
function parseEmailContent(emailContent: string, s3Key: string): Email {
  // メール本文を解析してEmailオブジェクトに変換
  const fromMatch = emailContent.match(/From:\s*(.+)/);
  const subjectMatch = emailContent.match(/Subject:\s*(.+)/);
  const bodyMatch = emailContent.match(/\n\n(.+)/s);
  
  return {
    id: generateId(),
    from: fromMatch ? fromMatch[1].trim() : 'Unknown',
    subject: subjectMatch ? subjectMatch[1].trim() : undefined,
    body: bodyMatch ? bodyMatch[1].trim() : emailContent,
    receivedAt: new Date().toISOString(),
    s3Key: s3Key
  };
}
```

### 4.3 画面表示機能

#### 4.3.1 メール一覧表示
- 受信したメールの一覧を表示
- 送信者、件名、受信日時を表示
- 未読/既読の状態表示

#### 4.3.2 メール詳細表示
- メールの詳細内容を表示
- 送信者、件名、本文を表示
- 本文はそのまま表示（HTML/テキスト）

## 5. 技術仕様

### 5.1 フロントエンド仕様
- **フレームワーク**: Next.js 14
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **状態管理**: React Hooks
- **API通信**: Next.js Server Actions

### 5.2 バックエンド仕様
- **ランタイム**: Node.js 18.x
- **フレームワーク**: Amplify Gen2 + Next.js Server Actions
- **データベース**: DynamoDB（Amplify data）
- **ストレージ**: S3（Amplify Storage）
- **認証**: 不要（匿名利用）

### 5.3 外部サービス仕様
- **S3バケット**: `otm-mec-mejsh-com-recieve`
- **プレフィックス**: `email/`
- **ドメイン**: `otm.mec.mejsh.com`
- **S3アクセス**: Amplify Storageを使用

## 6. セキュリティ設計

### 6.1 データ保護
- **暗号化**: DynamoDBの暗号化機能を使用
- **アクセス制御**: IAMロールによる適切な権限設定
- **ログ管理**: CloudWatch Logsでアクセスログを記録

### 6.2 レート制限
- **メールアドレス生成**: 1セッションあたり1回
- **S3チェック**: 30秒間隔
- **API呼び出し**: 適切なレート制限を設定

## 7. パフォーマンス設計

### 7.1 キャッシュ戦略
- **メール一覧**: クライアントサイドで30秒キャッシュ
- **メールアドレス**: セッション中は保持

### 7.2 スケーラビリティ
- **DynamoDB**: オートスケーリング
- **S3**: 標準的なスケーラビリティ

## 8. 監視・ログ設計

### 8.1 監視項目
- **メールアドレス生成数**: CloudWatch Metrics
- **S3アクセス数**: CloudWatch Metrics
- **エラー率**: CloudWatch Metrics
- **レスポンス時間**: CloudWatch Metrics

### 8.2 ログ設計
- **アクセスログ**: CloudWatch Logs
- **エラーログ**: CloudWatch Logs
- **S3アクセスログ**: CloudWatch Logs

## 9. 環境設定

### 9.1 環境変数
```bash
# ドメイン設定
EMAIL_DOMAIN=otm.mec.mejsh.com

# AWS設定
AWS_REGION=us-east-1
```

### 9.2 S3設定（amplify_outputs.json）
```json
{
  "storage": {
    "aws_region": "us-east-1",
    "bucket_name": "otm-mec-mejsh-com-recieve",
    "buckets": [
      {
        "name": "emailStorage",
        "bucket_name": "otm-mec-mejsh-com-recieve",
        "aws_region": "us-east-1",
        "paths": {
          "email/*": {
            "guest": ["get", "list"]
          }
        }
      }
    ]
  }
}
```

### 9.3 デプロイ設定
```yaml
# amplify.yml
version: 1
backend:
  phases:
    build:
      commands:
        - npm run build
frontend:
  phases:
    preBuild:
      commands:
        - npm install
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
```

## 10. 開発・運用

### 10.1 開発環境
- **ローカル開発**: `npm run dev`
- **テスト**: `npm run test`
- **ビルド**: `npm run build`

### 10.2 デプロイ
- **ステージング**: `npx ampx sandbox`
- **本番**: `npx ampx deploy`

### 10.3 監視・アラート
- **CloudWatch**: メトリクス監視
- **SNS**: アラート通知

---

**作成日**: 2024年12月19日  
**バージョン**: 1.0  
**作成者**: AI Assistant
