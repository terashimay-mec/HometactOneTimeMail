# OneTimeMail 開発指示テンプレート

## 概要
このファイルは、OneTimeMailと同様のアプリケーションを開発する際に、Cursorが理解しやすい指示をまとめたテンプレートです。

## 最終要件まとめ

### 1. プロジェクト概要
**目的**: IoTデバイス設定代行サービス向けの一時メールアドレス発行・受信サービス

**背景**: IoTデバイスの設定にはメールアドレスが必要だが、代行サービスでは多数のメールアドレスを用意するのが困難。一時的なメールアドレスを簡単に発行し、OTPを受信・参照できるサービスが必要。

**対象**: スマートフォンでの利用のみ（ダッシュボード不要）

### 2. 機能要件

#### 2.1 メールアドレス生成機能
- **生成タイミング**: 画面を開いた時点で自動生成
- **生成形式**: `{西暦右2桁}{月}{日}{連番3桁}@otm.mec.mejsh.com`
- **例**: `250908001@otm.mec.mejsh.com`
- **重複チェック**: 必須（DynamoDBで管理）
- **有効期限**: 画面を開いている間のみ有効、閉じてから1日で削除

#### 2.2 メール受信・表示機能
- **メール保存**: SESがS3に自動保存（アプリは参照のみ）
- **S3バケット**: `otm-mec-mejsh-com-recieve`
- **プレフィックス**: `email/`
- **チェック間隔**: 30秒ごと
- **表示機能**: メール一覧とメール詳細の両方
- **メール内容**: 本文をそのまま表示

#### 2.3 セッション管理
- **処理範囲**: 画面を開いている間のみ
- **認証**: 不要（匿名利用）

### 3. 技術要件

#### 3.1 技術スタック
- **フレームワーク**: Amplify Gen2 + Next.js 14
- **言語**: TypeScript
- **フロントエンド**: Next.js + Tailwind CSS
- **バックエンド**: Next.js Server Actions（APIの代わり）
- **データベース**: DynamoDB（Amplify data）
- **ストレージ**: S3（Amplify Storage）
- **認証**: 不要（匿名利用）

#### 3.2 外部サービス
- **SES**: メール受信・S3保存（アプリは直接操作しない）
- **S3**: メールファイル保存（アプリは参照のみ）
- **DynamoDB**: メールアドレス管理・重複チェック

#### 3.3 参考プロジェクト
- **構造参考**: `/Users/terashimay-mec/Work/Example/mdu_management`
- **実装方法**: Server Actions、Amplify data、Amplify Storageの使用方法を参考

### 4. 実装方針

#### 4.1 データ管理
- **Amplify data**: DynamoDB操作に使用（`generateClient<Schema>()`）
- **Amplify Storage**: S3操作に使用（`list`と`getUrl`）
- **Server Actions**: バックエンド処理に使用（`"use server"`）

#### 4.2 アーキテクチャ
- **フロントエンド**: Next.js App Router
- **バックエンド**: Server Actions（REST APIの代わり）
- **データベース**: DynamoDB（Amplify data経由）
- **ストレージ**: S3（Amplify Storage経由）

#### 4.3 設計書構成
1. **システム設計書**: 全体構成、機能設計、技術仕様
2. **Amplifyデータスキーマ設計書**: データモデル、Server Actions実装
3. **フロントエンド設計書**: コンポーネント設計、フック設計、スタイリング

## 開発時の注意点

### 技術選択の理由
- **SES vs S3**: SESはメール受信・S3保存のみ。アプリはS3を参照するだけ
- **Amplify data vs DynamoDBClient**: `generateClient<Schema>()`を使用（型安全性とGraphQLの恩恵）
- **S3 Client vs Amplify Storage**: `aws-amplify/storage`の`list`と`getUrl`を使用（認証とアクセス制御の自動化）
- **API vs Server Actions**: Next.js Server Actionsを使用（参考プロジェクトの構造に合わせる）

### 参考プロジェクトの活用
- **構造参考**: `/Users/terashimay-mec/Work/Example/mdu_management`
- **実装方法**: Server Actions、Amplify data、Amplify Storageの使用方法を参考
- **エラーハンドリング**: Server Actionの戻り値形式に統一

### 設計書作成の流れ
1. 要件定義の会話を数回行う
2. 設計書を作成する
3. 技術スタックの詳細を確認・修正する
4. 実装方法を明確化する

## 設計書の構成

### 1. システム設計書.md
- システム概要
- 全体構成図
- コンポーネント構成
- データ設計
- 機能設計
- 技術仕様
- セキュリティ設計
- パフォーマンス設計
- 監視・ログ設計
- 環境設定

### 2. Amplifyデータスキーマ設計書.md
- データモデル設計
- GraphQLスキーマ定義
- Server Actions実装
- メールアドレス生成ロジック
- 環境変数設定
- セキュリティ設定
- パフォーマンス最適化
- テスト設計

### 3. フロントエンド設計書.md
- プロジェクト構造
- 型定義
- コンポーネント設計
- カスタムフック設計
- Server Actions実装
- スタイリング設計
- レスポンシブデザイン
- エラーハンドリング
- パフォーマンス最適化

## 実装時の注意点

### Server Actionsの実装
```typescript
// app/actions/email-actions.ts
"use server";

import { generateClient } from 'aws-amplify/data';
import type { Schema } from '@/amplify/data/resource';

const client = generateClient<Schema>();

export async function createEmailAddress(): Promise<{
  success: boolean;
  data?: { id: string; address: string };
  error?: string;
}> {
  // 実装
}
```

### Amplify dataの使用
```typescript
// DynamoDBClientの代わりに
const client = generateClient<Schema>();

// 使用例
const { data, errors } = await client.models.EmailAddress.create({
  address,
  createdAt: Date.now(),
  isActive: true
});
```

### Amplify Storageの使用
```typescript
import { list, getUrl } from 'aws-amplify/storage';

// S3操作
const listResult = await list({
  prefix: 'email/',
  options: {
    bucketName: 'otm-mec-mejsh-com-recieve'
  }
});
```

## 実装例

### Server Actionsの実装パターン
```typescript
// app/actions/email-actions.ts
"use server";

import { generateClient } from 'aws-amplify/data';
import type { Schema } from '@/amplify/data/resource';

const client = generateClient<Schema>();

export async function createEmailAddress(): Promise<{
  success: boolean;
  data?: { id: string; address: string };
  error?: string;
}> {
  try {
    // 実装
    return { success: true, data: result };
  } catch (error) {
    return { success: false, error: 'Error message' };
  }
}
```

### エラーハンドリングの統一
- **戻り値形式**: `{ success: boolean; data?: T; error?: string }`
- **フロントエンド**: `result.success`で成功判定
- **エラー表示**: `result.error`でエラーメッセージ表示

---

**作成日**: 2024年12月19日  
**バージョン**: 1.0  
**用途**: 同様のアプリケーション開発時の指示テンプレート
